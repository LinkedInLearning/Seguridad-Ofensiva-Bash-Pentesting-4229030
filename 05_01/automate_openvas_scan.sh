#!/bin/bash

# Verificar si se proporciona un objetivo (IP o dominio)
if [ -z "$1" ]; then
    echo "Uso: $0 <IP_objetivo>"
    exit 1
fi

TARGET_IP=$1
TARGET_NAME="MyTarget"
SCAN_NAME="MyScan"
USERNAME="admin"
PASSWORD="password"

# Iniciar servicios de OpenVAS
echo "Iniciando OpenVAS..."
sudo gvm-start
sleep 30  # Esperar a que los servicios de OpenVAS se inicien completamente

# Crear un nuevo objetivo en OpenVAS
echo "Creando un nuevo objetivo..."
omp -u $USERNAME -w $PASSWORD --xml="<create_target><name>$TARGET_NAME</name><hosts>$TARGET_IP</hosts></create_target>"

# Obtener el ID del objetivo creado
TARGET_ID=$(omp -u $USERNAME -w $PASSWORD --get-targets | grep $TARGET_NAME | awk '{print $1}')

# Crear una nueva tarea de escaneo en OpenVAS
echo "Creando una nueva tarea de escaneo..."
omp -u $USERNAME -w $PASSWORD --xml="<create_task><name>$SCAN_NAME</name><config id='daba56c8-73ec-11df-a475-002264764cea'/><target id='$TARGET_ID'/></create_task>"

# Obtener el ID de la tarea de escaneo
TASK_ID=$(omp -u $USERNAME -w $PASSWORD --get-tasks | grep $SCAN_NAME | awk '{print $1}')

# Iniciar la tarea de escaneo
echo "Iniciando el escaneo para el objetivo $TARGET_NAME ($TARGET_IP)..."
omp -u $USERNAME -w $PASSWORD --start-task $TASK_ID

echo "Escaneo iniciado."

# Puedes agregar una opción para detener los servicios de OpenVAS después del escaneo:
# sudo gvm-stop
