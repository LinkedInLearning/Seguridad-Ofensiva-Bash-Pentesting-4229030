#!/bin/bash

# Variables
TARGET="http://tusitio.com"
NMAP_RESULTS="nmap_results.txt"
NIKTO_RESULTS="nikto_results.txt"
INFORME="informe_penetracion_$CI_COMMIT_SHORT_SHA.txt"
EMAIL="tuemail@dominio.com"
SLACK_WEBHOOK_URL="https://hooks.slack.com/services/XXX/YYY/ZZZ"

# Paso 1: Escaneo de puertos con nmap
echo "[+] Iniciando escaneo de puertos en $TARGET"
nmap -p 1-65535 -T4 -A -v $TARGET > $NMAP_RESULTS
echo "[+] Escaneo de puertos completado."

# Paso 2: Escaneo de vulnerabilidades web con Nikto
echo "[+] Iniciando escaneo de vulnerabilidades web en $TARGET"
nikto -h $TARGET > $NIKTO_RESULTS
echo "[+] Escaneo de vulnerabilidades completado."

# Paso 3: Generar informe consolidado
echo "[+] Generando informe consolidado en $INFORME"
{
  echo "Informe de Pruebas de Penetración - Commit $CI_COMMIT_SHORT_SHA"
  echo "=============================================================="
  echo ""
  echo "Resultados del escaneo de puertos (Nmap):"
  cat $NMAP_RESULTS
  echo ""
  echo "Resultados del escaneo de vulnerabilidades (Nikto):"
  cat $NIKTO_RESULTS
} > $INFORME

# Paso 4: Enviar informe por correo electrónico
echo "[+] Enviando informe por correo electrónico a $EMAIL"
mail -s "Informe de Pruebas de Penetración - Commit $CI_COMMIT_SHORT_SHA" $EMAIL < $INFORME

# Paso 5: Enviar notificación a Slack
echo "[+] Enviando notificación a Slack"
curl -X POST -H 'Content-type: application/json' \
  --data "{\"text\":\"Pruebas de penetración completadas para el commit $CI_COMMIT_SHORT_SHA. Revisa el informe en tu correo.\"}" \
  $SLACK_WEBHOOK_URL

echo "[+] Proceso de pruebas de penetración automatizado completado."



## Este script está diseñado para ser ejecutado como parte de un pipeline de CI/CD (por ejemplo, en Jenkins o GitLab CI),
## Integración con CI/CD: Este script está preparado para integrarse con herramientas de integración continua como GitLab CI o Jenkins. Utiliza variables como CI_COMMIT_SHORT_SHA para incluir detalles del commit en los informes.
## Notificación por Slack: Envía notificaciones a Slack después de que las pruebas de seguridad hayan sido completadas.
## Asegúrate de que Nmap, Nikto, y la herramienta de correo estén instalados.
## Configura el webhook de Slack y otros parámetros del entorno CI/CD.